---
title: "Data Analysis"
output: html_notebook
---
```{r}
library(ggplot2)
library(readr)

library(extrafont) 
library(tidyverse)

# execute once to add fonts:
# font_import() 

loadfonts(device='win')
windowsFonts("Latex" = windowsFont("CMU Serif"))

CTDC.2 = read_csv("../../Datasets/CTDC_Complete.csv")
```



Visuals for DTM Stage

```{r}
CTDC.2$citizenshipDTM = as.factor(CTDC.2$citizenshipDTM)
CTDC.2$exploitationDTM = as.factor(CTDC.2$exploitationDTM)
```


DTM Stages Data
```{r}
library(gridExtra)

# Citizenship DTM Barplot
cit_dtm_plot = ggplot(CTDC.2, aes(citizenshipDTM)) +
  geom_bar() + theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
   scale_fill_grey() +
  labs(x = "Citizenship DTM Stage", y = "Count")

# Exploit DTM Barplot
exp_dtm_plot = ggplot(CTDC.2, aes(exploitationDTM)) +
  geom_bar() + theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
   scale_fill_grey() +
  labs(x = "Exploitation DTM Stage", y = "Count")

#merge both plots within one grid
g <- gridExtra::grid.arrange(cit_dtm_plot, exp_dtm_plot, ncol = 2)
ggsave(file='./Graphics/DTMStagesBarplot.png', g, width = 8, height = 4)#saves g
```



```{r}
ggplot(CTDC.2, aes(citizenshipDTM, fill = exploitationDTM)) +
  geom_bar() + theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
   scale_fill_grey() +
  labs(x = "Citizenship DTM Stage", y = "Count", fill = "Exploitation DTM")
  
ggsave(file='./Graphics/DTMStage1.png', width = 8, height = 4)
```

Count how many cases have same citizenship and exploitation country.
```{r}
nrow(CTDC.2[CTDC.2$citizenship == CTDC.2$CountryOfExploitation,])
nrow(CTDC.2)
nrow(CTDC.2[CTDC.2$citizenship == CTDC.2$CountryOfExploitation,])/nrow(CTDC.2)
```


Same Country
```{r}
diff_country = CTDC.2[!(CTDC.2$citizenship == CTDC.2$CountryOfExploitation),]

ggplot(diff_country, aes(citizenshipDTM, fill = exploitationDTM)) +
  geom_bar() + theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
   scale_fill_grey() +
  labs(x = "Citizenship DTM Stage", y = "Count", fill = "Exploitation DTM")
  
ggsave(file='./Graphics/Different_CountryDTM.png', width = 8, height = 4)
```

Correlation Plot

```{r}
#Select Numeric Only
cor_df = CTDC.2[sapply(CTDC.2, class) != 'character']
cor_df$citizenshipDTM = as.numeric(cor_df$citizenshipDTM)
cor_df$exploitationDTM = as.numeric(cor_df$exploitationDTM)

library("Hmisc") # Gives P-Values for correlation
res2 <- rcorr(as.matrix(cor_df))


corr = res2$r # Correlations
corr_p = res2$P # P-values
```

Correlation Plot
```{r}
library(ggcorrplot)
library(ggplot2)

ggcorrplot(corr, colors = c("#242424", "#E7E7E7", "#242424"),
           tl.cex = 11, tl.srt = 90, show.diag = F,
          p.mat = corr_p, legend.title = "Correlation",
          ggtheme = ggplot2::theme_classic) +
  
  theme(text = element_text(family = "Latex", size = 12),
        axis.text.x = element_text(vjust = 0.1, hjust = 1),
        panel.background = element_rect(fill = '#242424'))

ggsave(file='./Graphics/CorrPlot.png', width = 7, height = 7)
```

More Visualizations

```{r}

```





Binary Percentage Visualization

```{r}
# Create Binary Percentage Dataframe
bin_perc <- CTDC.2 %>% group_by(exploitationDTM) %>% 
  summarise(across(names(CTDC.2[5:23]),sum),
            .groups = 'drop') %>%
  as.data.frame()

bin_perc = (bin_perc/nrow(CTDC.2))[2:ncol(bin_perc)]
```


```{r}
# Gather Dataframe and Add DTM Stages

gath <- bin_perc %>%
  as_data_frame()%>%
  gather(key = "variable", value = "value")

gath$exploitationDTM = rep(c(2,3,4,5),times = nrow(gath)/4)
```

Create Facet Plot
```{r}
# Make Facet Plot
ggplot(gath, aes(x = exploitationDTM,
           y = value)) +
    facet_wrap(~ variable, ncol = 3) +
    geom_bar(stat = "identity",
           position = "dodge") + theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
   scale_fill_grey()+
  labs(y= "Proportion", x = "Exploitation Country DTM Stage",
       title =  "Proportion of Type & Stage Out Of All Cases")

ggsave(file='./Graphics/FacetPlot1.png', width = 8.5, height = 10)
```



```{r}
ggplot(CTDC_binary_var_perc,
        +
   +
  scale_y_continuous(labels = scales::percent)
```

```{r}
# Loop through each column name
for (each_variable in names(CTDC_binary_var_perc[2:21])) {
  # Create a variable name to which the plot will be assigned
  plot_var_name <- str_c(c("ggplot", each_variable), collapse = "_")
  print(plot_var_name)
  # Compute the mean value of the variable 
  mean_val <- round(mean(df[, each_variable][[1]]), 3)
  print(mean_val)
  # Construct the plot
  temp_plot <- ggplot(df, aes_string(each_variable)) + # NOTE - aes_string rather than aes
    geom_histogram(binwidth = 0.05) +
    ggtitle(str_c("Distribution of ",each_variable)) +  # Title of the plot
    geom_vline(xintercept = mean_val, color = "blue", lty = "dashed")
  # Assign the plot to plot name
  assign(plot_var_name, temp_plot)
}

gridExtra::grid.arrange(ggplot_danceability, ggplot_acousticness, ggplot_liveness, ggplot_speechiness, ncol = 2)
```

