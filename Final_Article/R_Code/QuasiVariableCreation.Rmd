---
title: "Quasi Variable Analysis"
output: html_notebook
---

# Initializing Packages and Functions
```{r}
library(readr)
library(dplyr)
CTDC = read_csv("../../Datasets/CTDC.csv")[-1]
CTDC <- CTDC %>% relocate(CountryOfExploitation, .after = citizenship)
head(CTDC)
```

```{r}
library(ggplot2)

library(extrafont) 
library(tidyverse)

# execute once to add fonts:
# font_import() 

loadfonts(device='win')
windowsFonts("Latex" = windowsFont("CMU Serif"))
```

Remove Columns Function
```{r}
removed = c()

remove_columns <- function(remove){
  # Add Removed Columns to Removed List

  removed <<- append(unique(removed), remove)
  
  features = names(CTDC)

  # Update features to only include kept variables
  features = c(setdiff(features, remove))
  
  # Update CTDC to only have kept features
  CTDC <<- CTDC[features]
}
```

# Add DTM Stage to Data Set


Create dataframe with Alpha-2 codes,and DTM stage
```{r}
codes = read_csv("../../Datasets/CountryCodes.csv")
dtm = read_csv("../../Datasets/Countries_Data2.0.csv")[c(2,14)]

###### left join in R using merge() function 
df = merge(x=codes,y=dtm, by.x="Alpha-3 code", by.y = "Code", all.x=TRUE)
Code_DTM = df[c(3,6)]
```



Add column in CTDC with DTM stage for "countryOfExploitation"
```{r}

CTDC = merge(x=CTDC,y=Code_DTM, by.x="CountryOfExploitation", by.y = "Alpha-2 code", all.x=TRUE)

#rename DTM_Stage to exploitationDTM
names(CTDC)[ncol(CTDC)] = "exploitationDTM"
```

Add column in CTDC with DTM stage for "citizenship"
```{r}
CTDC = merge(x=CTDC,y=df, by.x="citizenship", by.y = "Alpha-2 code", all.x=TRUE)

#rename DTM_Stage to citizenshipDTM
names(CTDC)[ncol(CTDC)] = "citizenshipDTM"
```

Remove Unnecessary Joined Data


```{r}
remove = c("Alpha-3 code",
           "Numeric code","English short name lower case"
           ,"ISO 3166-2")

remove_columns(remove)
```

# Remove Concatonated Variables



```{r}
remove = c('meansOfControlConcatenated', 'typeOfExploitConcatenated',
           'typeOfLabourConcatenated', 'typeOfSexConcatenated',
           'RecruiterRelationship'
           )

remove_columns(remove)
```

# Make All Columns Factor

```{r}
library(dplyr)

# Double Data Type Columns
CTDC[sapply(CTDC, is.double)]<-CTDC[sapply(CTDC, is.double)] %>%
  replace(is.na(.), -1)

#Character Data Type Columns
CTDC[sapply(CTDC, is.character)]<-CTDC[sapply(CTDC, is.character)] %>%
  replace(is.na(.), "-1")
```

Add 0 and 1 as Factor Level for all columns

```{r}

for (i in 1:ncol(CTDC)){
  levels(CTDC[,i]) = append(levels(CTDC[,i]), c(0,1))
}
levels(CTDC$citizenship)
```


















# Initial Trends

Which Values Missing Together
```{r}
# Replace All Missing with 1, and all present values with 0
CTDC_mask = replace(CTDC, CTDC!=-1, 0)
CTDC_mask = replace(CTDC_mask, CTDC_mask == -1, 1)

CTDC_mask = CTDC_mask %>% mutate_if(is.factor,as.character)%>% mutate_if(is.character,as.numeric)
CTDC_mask 
```

Correlation Plot
```{r}

library("Hmisc") # Gives P-Values for correlation
res2 <- rcorr(as.matrix(CTDC_mask))


corr = res2$r # Correlations
corr_p = res2$P # P-values

library(ggcorrplot)
library(ggplot2)

ggcorrplot(corr, colors = c("blue", "#E7E7E7", "red"),
           tl.cex = 11, tl.srt = 90, show.diag = F, legend.title = "Correlation",
          ggtheme = ggplot2::theme_classic) +
  
  theme(text = element_text(family = "Latex", size = 12),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#242424'))
```

Heat Map

```{r}
library(pheatmap)
pheatmap(CTDC_mask[1:10000,], treeheight_row = 0, treeheight_col = 0)
```
```{r}
l = lm(exploitationDTM~.-CountryOfExploitation-citizenship-citizenshipDTM, data = CTDC)
summary(l)
```

