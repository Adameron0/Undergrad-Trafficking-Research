---
title: "Final Report Code"
output: pdf_document
---

```{r}
library(extrafont) 
library(tidyverse)

# execute once to add fonts:
# font_import() 

loadfonts(device='win')
windowsFonts("Latex" = windowsFont("CMU Serif"))
```




```{r}
library(ggplot2)
library(ggthemes)
library(Cairo)
```




# Import Data
```{r, echo = F, message = F}
library(readr)

CTDC = read_csv("../../Datasets/CTDC.csv")[-c(1)]# Remove Terms of Use Column
```

# Section # Manipulating CTDC Dataset

# Count Number of Complete Cases in Unaltered Data Set
```{r}
sum(complete.cases(CTDC)) # Counts number of Complete Cases
```

# Initialize List of Removed Variables

```{r}
removed = c()
```



# Function to Remove Variables From CTDC

```{r}
remove_columns <- function(remove){
  features = names(CTDC)

  # Update features to only include kept variables
  features = c(setdiff(features, remove))
  
  # Update CTDC to only have kept features
  CTDC <<- CTDC[features]
  
  # Complete Cases
  cases = sum(complete.cases(CTDC))
  print(paste(cases, "complete cases"))
}
```



# Section #.# Logically Removing Variables

```{r}
removed = append(removed, c(
           'yearOfRegistration','Datasource','majorityStatus',
           'meansOfControlConcatenated', 'typeOfExploitConcatenated',
           'typeOfLabourConcatenated', 'typeOfSexConcatenated',
           'majorityStatusAtExploit', 'majorityEntry'
           ))

remove_columns(removed)
```

# Section #.# Quantitatively Removing Variables

## Remove Variables With One Unique Value
```{r}


for (x in 1:ncol(CTDC)) { # Loop over all columns
  column = CTDC[x]
  unq_vals = unique(column)
  
  no_na = na.omit(unq_vals) # Remove NA value from list
  
  n_rem = nrow(no_na) # Count Remaining Unique Values

  # If Number of Values <= 1 then add to remove list
  if (n_rem <= 1){
    removed = append(removed, names(CTDC)[x])
  }
  

}


# Remove from Data Set
remove_columns(removed)
```

# NA Visualizations

```{r}
library(ggplot2)
library(ggthemes)
path = './Graphics'


```

# NA Barplot

```{r}
na_cnts = unname(colSums(is.na(CTDC))) #Array of NA counts

#NA Count Dataframe
na_df = data.frame(Variable = names(CTDC), Count = na_cnts)
```

Plot with no Variable Names
```{r}

# Only include top Number (n) of missings
n = 51

top = sort(na_df$Count, decreasing = TRUE)[n]
top = na_df[na_df$Count >= top,]

ggplot(top, aes(x = reorder(Variable, Count),y = Count)) +
  geom_bar(stat = "identity", width = 1) +
  # Theme and Layout Stuff
  theme_grey(base_size = 8) +
  theme(axis.text.y=element_blank(),axis.ticks.y=element_blank(),
        text = element_text(family = "Latex", size = 15)) +
  xlab("Variable") + ylab("Count of NAs") + coord_flip() +
  # Add Vertical line at 75000
  geom_hline(yintercept = 75000, linetype="solid", 
                color = "salmon", size=2, alpha=0.6)

ggsave(file='./Graphics/NABarplot.png', width=6, height=3)
```

```{r}
# Only include variables with missing count over n
n = 75000

top = na_df[na_df$Count >= n,]

ggplot(top, aes(x = reorder(Variable, Count),y = Count)) +
  geom_bar(stat = "identity", width = 1) +
  # Theme and Layout Stuff
  theme_grey(base_size = 8) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) +
   xlab(element_blank()) + ylab("Count of NAs") + coord_flip(ylim=c(75000,95000))
  # Add Vertical line at 75000

ggsave(file='./Graphics/NABarplot2.png', width=6, height=3)
```

Means of Control Analysis/Removal

```{r}
#Means of Control Only
moc = CTDC[c(4:20)]
not_spec = CTDC$meansOfControlNotSpecified

table(not_spec)
```

```{r}
moc[is.na(moc)] = 0

ggplot(moc, aes(x=rowSums(moc))) + geom_histogram(binwidth = 1) +
  theme_grey(base_size = 16) +
  theme(axis.text = element_text(size = 9),
    text = element_text(family = "Latex", size = 15)) + 
  xlab("Means of Control Row Sum") + ylab("Occurances")
  
ggsave(file='./Graphics/MeansOfControlSumHist.png', width=6, height=3)
```

```{r}
remove = c("meansOfControlDebtBondage"             
,"meansOfControlTakesEarnings"           
,"meansOfControlRestrictsFinancialAccess"
,"meansOfControlThreats"                 
,"meansOfControlPsychologicalAbuse"      
,"meansOfControlPhysicalAbuse"           
,"meansOfControlSexualAbuse"             
,"meansOfControlFalsePromises"           
,"meansOfControlPsychoactiveSubstances"  
,"meansOfControlRestrictsMovement"       
,"meansOfControlRestrictsMedicalCare"    
,"meansOfControlExcessiveWorkingHours"   
,"meansOfControlUsesChildren"            
,"meansOfControlThreatOfLawEnforcement"  
,"meansOfControlWithholdsNecessities"    
,"meansOfControlWithholdsDocuments"      
,"meansOfControlOther"                   
,"meansOfControlNotSpecified")

remove_columns(remove)
```

Naniar Missing Visualizations

```{r}
library(naniar)
vis_miss(CTDC, warn_large_data = FALSE) +
  theme(axis.text.y = element_blank(),
    text = element_text(family = "Latex", size = 12),
    axis.text.x = element_text(angle = -90, hjust=1),
    axis.title.y = element_text(angle = -90),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    ) +
  guides(fill = guide_legend(label.theme = element_text(family = "Latex", angle = -90)))
    

ggsave(file='./Graphics/NaniarVis1.png', width = 6, height = 8)
```

Remove isSlaveryAndPractices and isForcedMArriage

```{r}
remove = c("isSlaveryAndPractices","isForcedMarriage")

remove_columns(remove)
```

Missing Variables Together

```{r}
gg_miss_upset(CTDC)
```

